<%- include('../partials/header') %>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <%- include('../partials/sidebar') %>

        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">
                    <i class="bi bi-person-check"></i>
                    Parent Registration Requests
                </h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <button type="button" class="btn btn-outline-secondary" onclick="filterRequests('all')">
                            All Requests
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="filterRequests('pending')">
                            Pending
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="filterRequests('approved')">
                            Approved
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="filterRequests('rejected')">
                            Rejected
                        </button>
                    </div>
                </div>
            </div>

            <% if (typeof error !== 'undefined' && error) { %>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle"></i>
                    <%= error %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            <% } %>

            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-list-ul"></i>
                                Registration Requests
                                <span class="badge bg-primary ms-2"><%= requests.length %></span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <% if (requests.length === 0) { %>
                                <div class="text-center py-5">
                                    <i class="bi bi-inbox display-4 text-muted"></i>
                                    <h5 class="mt-3 text-muted">No Registration Requests</h5>
                                    <p class="text-muted">There are no parent registration requests at this time.</p>
                                </div>
                            <% } else { %>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Parent Details</th>
                                                <th>Contact</th>
                                                <th>Children Names</th>
                                                <th>Status</th>
                                                <th>Request Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="requestsTableBody">
                                            <% requests.forEach(request => { %>
                                                <tr data-status="<%= request.status %>" class="request-row">
                                                    <td>
                                                        <div>
                                                            <strong><%= request.first_name %> <%= request.last_name %></strong>
                                                            <br>
                                                            <small class="text-muted"><%= request.email %></small>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <% if (request.phone) { %>
                                                            <i class="bi bi-telephone"></i>
                                                            <%= request.phone %>
                                                        <% } else { %>
                                                            <span class="text-muted">No phone</span>
                                                        <% } %>
                                                    </td>
                                                    <td>
                                                        <% if (request.student_names && request.student_names.length > 0) { %>
                                                            <% request.student_names.forEach((name, index) => { %>
                                                                <span class="badge bg-light text-dark me-1"><%= name %></span>
                                                                <% if (index < request.student_names.length - 1) { %><br><% } %>
                                                            <% }) %>
                                                        <% } else { %>
                                                            <span class="text-muted">No children specified</span>
                                                        <% } %>
                                                    </td>
                                                    <td>
                                                        <% if (request.status === 'pending') { %>
                                                            <span class="badge bg-warning">
                                                                <i class="bi bi-clock"></i> Pending
                                                            </span>
                                                        <% } else if (request.status === 'approved') { %>
                                                            <span class="badge bg-success">
                                                                <i class="bi bi-check-circle"></i> Approved
                                                            </span>
                                                        <% } else if (request.status === 'rejected') { %>
                                                            <span class="badge bg-danger">
                                                                <i class="bi bi-x-circle"></i> Rejected
                                                            </span>
                                                        <% } %>
                                                    </td>
                                                    <td>
                                                        <small>
                                                            <%= moment(request.created_at).format('MMM DD, YYYY') %>
                                                            <br>
                                                            <span class="text-muted">
                                                                <%= moment(request.created_at).format('HH:mm') %>
                                                            </span>
                                                        </small>
                                                    </td>
                                                    <td>
                                                        <% if (request.status === 'pending') { %>
                                                            <div class="btn-group btn-group-sm">
                                                                <button 
                                                                    class="btn btn-outline-success"
                                                                    onclick="approveRequest('<%= request.id %>')"
                                                                    title="Approve Request"
                                                                >
                                                                    <i class="bi bi-check"></i>
                                                                </button>
                                                                <button 
                                                                    class="btn btn-outline-danger"
                                                                    onclick="rejectRequest('<%= request.id %>')"
                                                                    title="Reject Request"
                                                                >
                                                                    <i class="bi bi-x"></i>
                                                                </button>
                                                                <button 
                                                                    class="btn btn-outline-primary"
                                                                    onclick="viewRequestDetails('<%= request.id %>')"
                                                                    title="View Details"
                                                                >
                                                                    <i class="bi bi-eye"></i>
                                                                </button>
                                                            </div>
                                                        <% } else { %>
                                                            <small class="text-muted">
                                                                <% if (request.reviewed_by_name) { %>
                                                                    Reviewed by: <%= request.reviewed_by_name %>
                                                                    <br>
                                                                <% } %>
                                                                <% if (request.reviewed_at) { %>
                                                                    <%= moment(request.reviewed_at).format('MMM DD, YYYY') %>
                                                                <% } %>
                                                            </small>
                                                        <% } %>
                                                    </td>
                                                </tr>
                                            <% }) %>
                                        </tbody>
                                    </table>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Rejection Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-x-circle text-danger"></i>
                    Reject Registration Request
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="rejectionReason" class="form-label">
                        Reason for Rejection <span class="text-danger">*</span>
                    </label>
                    <textarea 
                        class="form-control" 
                        id="rejectionReason" 
                        rows="3"
                        placeholder="Please provide a reason for rejecting this request..."
                        required
                    ></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmRejectBtn">
                    <i class="bi bi-x-circle"></i>
                    Reject Request
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentRequestId = null;

function filterRequests(status) {
    const rows = document.querySelectorAll('.request-row');
    rows.forEach(row => {
        if (status === 'all' || row.dataset.status === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update button states
    document.querySelectorAll('.btn-outline-secondary, .btn-outline-warning, .btn-outline-success, .btn-outline-danger')
        .forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

function approveRequest(requestId) {
    if (confirm('Are you sure you want to approve this parent registration request? This will create a parent account and send login credentials via email.')) {
        fetch(`/admin/parent-requests/${requestId}/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Parent request approved successfully!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification(data.message || 'Failed to approve request', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred while approving the request', 'error');
        });
    }
}

function rejectRequest(requestId) {
    currentRequestId = requestId;
    const modal = new bootstrap.Modal(document.getElementById('rejectModal'));
    modal.show();
}

function viewRequestDetails(requestId) {
    // This could open a detailed view modal
    console.log('View details for request:', requestId);
}

// Handle reject confirmation
document.getElementById('confirmRejectBtn').addEventListener('click', function() {
    const reason = document.getElementById('rejectionReason').value.trim();
    
    if (!reason) {
        showNotification('Please provide a reason for rejection', 'error');
        return;
    }
    
    fetch(`/admin/parent-requests/${currentRequestId}/reject`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            rejectionReason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Parent request rejected successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('rejectModal')).hide();
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(data.message || 'Failed to reject request', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while rejecting the request', 'error');
    });
});

function showNotification(message, type) {
    // Create a simple toast notification
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}
</script>

<%- include('../partials/footer') %>
